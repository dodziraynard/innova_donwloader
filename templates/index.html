<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <meta charset="utf-8">
    <title>Face Counter</title>
    <link href="{% static 'css/styles.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
</head>

<body>
    <h2 class="text text-center">Face Counter</h2>
    <div>
        <div class="control" style="margin: auto; width: 50%;"><button id="tryIt" disabled
                style="width: 100%; margin:auto; text-align:center; background-color: rgb(49, 85, 184); color: white; padding: 10px;">Try
                it</button></div>
        <textarea style="display: none;" class="code" rows="9" cols="100" id="codeEditor" spellcheck="false"></textarea>
        <p class="err" id="errorMessage"></p>
    </div>

    <div class="row">
        <div class="col-md-6 col-sm-12 col-xs-12"
            style="display: flex; flex-direction: column; justify-content: center;">
            <h3 class="text text-muted text-center">Video In</h3>
            <video id="video" width="500px" height="500px" class="col-md-6 col-sm-12 col-xs-12"></video>
        </div>

        <div class="col-md-6 col-sm-12 col-xs-12">
            <h3 id="face_count" class="text text-muted text-center">Face Detected Faces: </h3>
            <canvas id="canvasOutput" style="width: 500px;"
                style="display: flex; flex-direction: column; justify-content: center;" style="margin:auto;"></canvas>
        </div>

    </div>

    <script src=" {% static 'js/utils.js' %}" type="text/javascript"></script>
    <script id="codeSnippet" type="text/code-snippet">
        //let src = cv.imread('canvasInput');
        let src = null
        let faceCount = document.querySelector("#face_count")
        let faces = new cv.RectVector();
        let eyes = new cv.RectVector();
        let faceCascade = new cv.CascadeClassifier();
        let eyeCascade = new cv.CascadeClassifier();
        // load pre-trained classifiers
        faceCascade.load('haarcascade_frontalface_default.xml');
        eyeCascade.load('haarcascade_eye.xml');
        
        // detect faces
        
        let video = document.getElementById('video');
      
        const FPS = 30;
        function processVideo() {
            let begin = Date.now();
            
            src = new cv.Mat(video.height, video.width, cv.CV_8UC4);

            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
            let cap = new cv.VideoCapture(video);
    
            cap.read(src);
            let msize = new cv.Size(0, 0);
            faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);
            for (let i = 0; i < faces.size(); ++i) {
               let point1 = new cv.Point(faces.get(i).x, faces.get(i).y);
                let point2 = new cv.Point(faces.get(i).x + faces.get(i).width, faces.get(i).y + faces.get(i).height);
                cv.rectangle(src, point1, point2, [0, 255, 0, 255]);
           }

            cv.imshow('canvasOutput', src);
            faceCount.innerText = "Face Detected Faces: "+faces.size()
            src.delete()
            gray.delete()
            // schedule next one.
            let delay = 1000/FPS - (Date.now() - begin);
            console.log(delay)
            setTimeout(processVideo, delay);
        }

        // schedule first one.
        setTimeout(processVideo, 0);

        
</script>
    <script type="text/javascript">
        let utils = new Utils('errorMessage');

        utils.loadCode('codeSnippet', 'codeEditor');
        // utils.loadImageToCanvas('static/pic1.jpeg', 'canvasInput');
        // utils.addFileInputHandler('fileInput', 'canvasInput');

        let tryIt = document.getElementById('tryIt');
        tryIt.addEventListener('click', () => {
            utils.executeCode('codeEditor');
        });

        utils.loadOpenCv(() => {
            let eyeCascadeFile = 'static/haarcascade_eye.xml';
            utils.createFileFromUrl("haarcascade_eye.xml", eyeCascadeFile, () => {
                let faceCascadeFile = 'static/haarcascade_frontalface_default.xml';
                utils.createFileFromUrl("haarcascade_frontalface_default.xml", faceCascadeFile, () => {
                    tryIt.removeAttribute('disabled');
                });
            });
        });

        utils.startCamera(1, null, "video")

        let video = document.querySelector("video")
        console.log(video.style.height)
    </script>
</body>

</html>