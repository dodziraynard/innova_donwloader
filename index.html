<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Face Detection Example</title>
    <link href="js_example_style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <h2>Face Detection Example</h2>
    <p>
        &lt;canvas&gt; elements named <b>canvasInput</b> and <b>canvasOutput</b> have been prepared.<br>
        Click <b>Try it</b> button to see the result. You can choose another image.<br>
        You can change the code in the &lt;textarea&gt; to investigate more.
    </p>
    <div>
        <div class="control"><button id="tryIt" disabled>Try it</button></div>
        <textarea class="code" rows="9" cols="100" id="codeEditor" spellcheck="false">
</textarea>
        <p class="err" id="errorMessage"></p>
    </div>
    <div>
        <table cellpadding="0" cellspacing="0" width="0" border="0">
            <tr>
                <td>
                    <canvas id="canvasInput"></canvas>
                </td>
                <td>
                    <canvas id="canvasOutput"></canvas>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="caption">canvasInput <input type="file" id="fileInput" name="file" accept="image/*" />
                    </div>
                </td>
                <td>
                    <div class="caption">canvasOutput</div>
                </td>
            </tr>
        </table>
    </div>

    <video id="video" width="500" height="500"></video>
    <script src="utils.js" type="text/javascript"></script>
    <script id="codeSnippet" type="text/code-snippet">
        let src = cv.imread('canvasInput');
        
        let faces = new cv.RectVector();
        let eyes = new cv.RectVector();
        let faceCascade = new cv.CascadeClassifier();
        let eyeCascade = new cv.CascadeClassifier();
        // load pre-trained classifiers
        faceCascade.load('haarcascade_frontalface_default.xml');
        eyeCascade.load('haarcascade_eye.xml');
        
        // detect faces
        
        let video = document.getElementById('video');
      
        const FPS = 60;
        function processVideo() {
            let begin = Date.now();
            
            src = new cv.Mat(video.height, video.width, cv.CV_8UC4);

            let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
            let cap = new cv.VideoCapture(video);
    
            cap.read(src);
                let msize = new cv.Size(0, 0);
            faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);
            for (let i = 0; i < faces.size(); ++i) {
                let point1 = new cv.Point(faces.get(i).x, faces.get(i).y);
                let point2 = new cv.Point(faces.get(i).x + faces.get(i).width,
                                        faces.get(i).y + faces.get(i).height);
                cv.rectangle(src, point1, point2, [0, 255, 0, 255]);
            }


            cv.imshow('canvasOutput', src);
            // schedule next one.
            let delay = 1000/FPS - (Date.now() - begin);
            console.log(delay)
            setTimeout(processVideo, delay);
        }

        
        // schedule first one.
        setTimeout(processVideo, 0);

        
</script>
    <script type="text/javascript">
        let utils = new Utils('errorMessage');

        utils.loadCode('codeSnippet', 'codeEditor');
        utils.loadImageToCanvas('pic1.jpeg', 'canvasInput');
        utils.addFileInputHandler('fileInput', 'canvasInput');

        let tryIt = document.getElementById('tryIt');
        tryIt.addEventListener('click', () => {
            utils.executeCode('codeEditor');
        });

        utils.loadOpenCv(() => {
            let eyeCascadeFile = 'haarcascade_eye.xml';
            utils.createFileFromUrl(eyeCascadeFile, eyeCascadeFile, () => {
                let faceCascadeFile = 'haarcascade_frontalface_default.xml';
                utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
                    tryIt.removeAttribute('disabled');
                });
            });
        });

        utils.startCamera(1, null, "video")
    </script>
</body>

</html>